name: deployment production

on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõé
        uses: actions/checkout@master
        
      - name: Set up Node.js üë®üèª‚Äçüíª
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm' 
      - name: Install dependencies üë®üèª‚Äçüíª
        run: npm ci
        continue-on-error: false
      
      - name: Build app üèóÔ∏è
        run: npm run build
        env:
          VITE_BASE_API: https://api.omniassisto.com/api/v1
          VITE_GOOGLE_MAPS_API_KEY: AIzaSyDG8ZNpNvt6YLCCP3h5Mphri6GU_BRynN0
          VITE_FIREBASE_APIKEY: AIzaSyCgdINMRQvZxsa3XkA6DRZAgQjvQEQ7R8A
        
      

      
      - name: View dist folder contents üëÄ
        run: ls -l dist
      
      - name: SETUP SSH üíª
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIV_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          ssh-keyscan -p ${{ secrets.HOST_PORT }} -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
          
          cat <<EOF > ~/.ssh/config
          Host production_server
            HostName ${{ secrets.HOST }}
            User ${{ secrets.HOST_USER }}
            Port ${{ secrets.HOST_PORT }}
            IdentityFile ~/.ssh/id_rsa
            IdentitiesOnly yes
            PubkeyAcceptedAlgorithms +ssh-rsa
          EOF
          chmod 600 ~/.ssh/config
      
      - name: copy builds to server üöÄ
        id: deploy
        run: |
          scp  -r dist/* production_server:/var/www/admin.omniassisto.com
          echo "** ¬°Hola! Se ha realizado la conexi√≥n SSH correctamente. **"
        continue-on-error: false
      # ‚úÖ Notificaci√≥n de √©xito global
      - name: Notify Success ‚úÖ
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚úÖ *OMNI ADMIN* || Despliegue exitoso en Production üöÄ%0ARepo: ${{ github.repository }}%0ABranch: ${{ github.ref_name }}"
      # ‚ö†Ô∏è Notificaci√≥n de fallo global
      - name: Notify Failure ‚ùå
        if: failure()
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå *OMNI ADMIN* || Fall√≥ el despliegue üö®%0Aüß± Job: ${{ github.job }}%0Aüì¶ Estado: ${{ job.status }}%0ARepo: ${{ github.repository }}%0ABranch: ${{ github.ref_name }}%0Aüîç [Ver logs en GitHub Actions]($LOG_URL)"
