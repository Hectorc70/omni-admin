name: deployment production

on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›
        uses: actions/checkout@master
        
      - name: Set up Node.js ğŸ‘¨ğŸ»â€ğŸ’»
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm' 
      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run: npm ci
        continue-on-error: false
      
      - name: Build app ğŸ—ï¸
        run: npm run build
        env:
          VITE_BASE_API: https://api.omniassisto.com/api/v1
          VITE_GOOGLE_MAPS_API_KEY: AIzaSyDG8ZNpNvt6YLCCP3h5Mphri6GU_BRynN0
          VITE_FIREBASE_APIKEY: AIzaSyCgdINMRQvZxsa3XkA6DRZAgQjvQEQ7R8A
        
      

      
      - name: View dist folder contents ğŸ‘€
        run: ls -l dist
      
      - name: SETUP SSH ğŸ’»
        run: |
          mkdir -p ~/.ssh/
          # El '-' despuÃ©s de '<<' elimina la indentaciÃ³n de las pestaÃ±as, 
          echo "${{ secrets.SSH_PRIV_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          ssh-keyscan -p ${{ secrets.HOST_PORT }} -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
          
          cat <<EOF > ~/.ssh/config
          Host production_server
            HostName ${{ secrets.HOST }}
            User ${{ secrets.HOST_USER }}
            Port ${{ secrets.HOST_PORT }}
            IdentityFile ~/.ssh/id_rsa
            IdentitiesOnly yes
            PubkeyAcceptedAlgorithms +ssh-rsa
          EOF
          chmod 600 ~/.ssh/config
      
      - name: copy builds to server ğŸš€
        id: deploy
        run: |
          scp  -r dist/* production_server:/var/www/admin.omniassisto.com
          echo "** Â¡Hola! Se ha realizado la conexiÃ³n SSH correctamente. **"
        continue-on-error: false
      # âœ… NotificaciÃ³n de Ã©xito global
      - name: Notify Success âœ…
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âœ… *OMNI ADMIN* || Despliegue exitoso en Production ğŸš€%0ARepo: ${{ github.repository }}%0ABranch: ${{ github.ref_name }}"
      # âš ï¸ NotificaciÃ³n de fallo global
      - name: Notify Failure âŒ
        if: failure()
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âŒ *OMNI ADMIN* || FallÃ³ el despliegue ğŸš¨%0AğŸ§± Job: ${{ github.job }}%0AğŸ“¦ Estado: ${{ job.status }}%0ARepo: ${{ github.repository }}%0ABranch: ${{ github.ref_name }}%0AğŸ” [Ver logs en GitHub Actions]($LOG_URL)"
